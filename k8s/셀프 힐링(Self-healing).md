# Kubernetes 셀프 힐링(Self-healing) 정리
---
## 셀프 힐링이란?

#### Kubernetes의 **셀프 힐링** 기능은 **장애가 발생한 리소스를 자동으로 감지하고 복구**하는 기능입니다.
#### 즉, 사람이 직접 개입하지 않아도 쿠버네티스가 시스템의 상태를 모니터링하고 **정상 상태로 되돌리려는 행동을 자동 수행**합니다.
---
## 셀프 힐링이 적용되는 주요 리소스
| 리소스 | 동작 설명 |
|--------|-----------|
| **Pod** | 컨테이너가 죽거나 비정상 상태가 되면, kubelet이 자동으로 재시작하거나 교체 |
| **Deployment** | ReplicaSet을 통해 지정된 수의 Pod가 유지되도록 자동 복구 |
| **StatefulSet** | 고유한 상태를 가진 Pod도 순차적으로 복구 |
| **Node** | 노드가 다운되면 해당 노드의 Pod들을 다른 노드로 재스케줄링 (다만 수동 설정 필요) |
---
## 작동 방식
- **kubelet**: 노드 내에서 컨테이너 상태를 감지하고 재시작 시도
- **Controller Manager**: Replica 수가 부족하면 새 Pod를 생성하여 상태 복구
- **Scheduler**: 재스케줄링이 필요한 경우 다른 노드에 Pod를 재배치
---
## 관련 헬스체크 설정
| 항목 | 설명 |
|------|------|
| `livenessProbe` | 이 체크가 실패하면, **컨테이너를 재시작**하여 복구 시도 |
| `readinessProbe` | 이 체크가 실패하면, **서비스 트래픽에서 제외**되며, 복구 대기 |
| `startupProbe` | 애플리케이션 시작 시 시간 오래 걸릴 때 사용, **시작 완료될 때까지 기다림** |
```yaml
livenessProbe:
httpGet:
path: /health
port: 8080
initialDelaySeconds: 5
periodSeconds: 10
```
---
## 셀프 힐링이 동작하는 예시 시나리오
| 상황 | 셀프 힐링 동작 |
|------|----------------|
| Pod가 CrashLoopBackOff 됨 | kubelet이 컨테이너 재시작 시도 |
| 노드가 다운됨 | 스케줄러가 다른 노드에 Pod 재배치 (taint 설정 시 제외 가능) |
| 컨테이너가 500 응답 반복 | livenessProbe 실패 → 컨테이너 재시작 |
| 지정된 Pod 개수보다 적음 | ReplicaSet이 새 Pod 생성 |
---
## 한계점 / 주의사항
- 애플리케이션 레벨의 오류는 **알아서 해결 못함** (ex. DB 커넥션 끊김, 메모리 누수 등)
- Node 장애 시 자동 복구는 노드 컨트롤러 설정(`--node-monitor-grace-period`)과 PodDisruption 설정이 필요함
- 영속 상태(Stateful)는 복구에 더 신중해야 함
---
---
## 셀프 힐링의 보완이 필요한 부분과 대체 전략
| 보완이 필요한 점 | 설명 | 대체 또는 보완 방안 |
|------------------|------|---------------------|
| 애플리케이션 레벨 문제는 감지 불가 | 컨테이너는 살아있지만 내부 기능은 오류인 경우 (`DB 연결 끊김`, `무한 루프`, 등) | `livenessProbe`, `readinessProbe`, `애플리케이션 자체 모니터링 로직` 도입 |
| 복잡한 장애 상황은 자동 대응 어려움 | 예: 디스크 공간 부족, 네트워크 단절, 다운스트림 서비스 장애 | `Prometheus` + `Alertmanager`로 모니터링 + 알림 / `자동 롤백 스크립트` 연동 |
| Stateful 서비스 복구는 민감함 | 상태 저장 앱은 단순 재시작으로 복구가 안 될 수 있음 | `StatefulSet + VolumeBackup` 전략 / `오퍼레이터(Operator)` 도입 |
| 노드 장애 시 완전 자동화 아님 | 기본적으로 노드 장애는 수동 대처 필요 (파드 재스케줄링은 설정해야 작동) | `PodDisruptionBudget`, `Node Auto Repair`, `클러스터 오토스케일러` 활용 |
| 설정 오류는 셀프 힐링 대상 아님 | 잘못된 YAML, 무한 롤링 업데이트 등은 스스로 고치지 못함 | `ArgoCD`, `FluxCD` 등 GitOps 기반 CI/CD로 선언적 배포 관리 |
---
## 셀프 힐링 요약
| 항목 | 내용 |
|------|------|
| 목적 | 장애 발생 시 시스템이 자동으로 복구 시도 |
| 방법 | kubelet, Controller, Scheduler가 상태 모니터링 및 복구 수행 |
| 조건 | Replica 수, 헬스체크, Pod 템플릿 등이 명확히 설정되어야 함 |
| 결과 | 사람이 개입하지 않아도 시스템이 **자동으로 정상 상태를 유지**하려고 함 |
